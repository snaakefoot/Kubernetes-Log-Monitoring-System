import akka.actor.testkit.typed.scaladsl.ActorTestKit
import akka.actor.typed.ActorRef

import scala.util.Right
import com.handler.model.updateNtt
import com.handler.actor.entityHandler
import com.handler.model.MyEntity._
import org.scalatest.wordspec.AnyWordSpecLike
import org.scalatest.BeforeAndAfterAll
import org.scalatest.matchers.should.Matchers

import com.typesafe.config.ConfigFactory

import com.handler.model.nttUpdated
// Assuming 'entityHandler' and 'updateNtt' are appropriately defined in your application.
// Please replace 'YourActor', 'createNtt', 'getIds', 'updateNtt' with actual implementations.

class MyActorSpec extends AnyWordSpecLike with BeforeAndAfterAll with Matchers {
  val testKit = ActorTestKit("MyActorSpec", ConfigFactory.load("application.conf"))

  override def afterAll(): Unit = {
    testKit.shutdownTestKit()
  }

  "MyActor" should {
    "correctly process updateNtt messages" when {
      "the message is of the correct type" in {
        // Define JSON strings and parse them to your Ntt type
        val jsonString1 = """{"@timestamp":1712143157.638594,"stream":"stdout","logtag":"F","message":"2024-04-03 11:19:17.638 INFO  com.cognira.shared.metric.models.MetricsEntity - Logs for FluentBit are : {\"id\":\"1userpromo\",\"p1\":\"1\",\"c1\":\"P00000011\",\"permission\":\"tests\",\"batch_forecasted\":null,\"promotional_sales_margin_dollars_if\":null,\"fiscal_period\":[\"202409\"],\"sales_margin_dollars_lift_td\":null,\"location_group_ids\":[\"All_Stores_CUB\"],\"base_aur_af\":null,\"base_auc_if\":null,\"created_by\":\"Promo Planner\",\"assignee_id\":\"2\",\"promotional_sales_dollars_sf\":null,\"category_managers\":[],\"base_sales_units_if\":null,\"forecast_gross_margin_percent\":null,\"sales_margin_dollars_lift_uf\":null,\"base_sales_units_td\":null,\"promo_approver\":null,\"do_not_send_pricing_to_ea\":true,\"total_sales_units_sf\":null,\"regular_sales_dollars_af\":null,\"sub_category\":[\"REFRIGERATOR\"],\"base_sales_dollars_af\":null,\"total_sales_dollars_af\":null,\"promotional_sales_units_af\":null,\"base_sales_dollars_uf\":null,\"base_sales_margin_dollars_uf\":null,\"created_by_id\":\"2\",\"base_cost_dollars_min_uf\":null,\"total_sales_dollars_af_rel_diff_to_td\":null,\"primary_image_id\":null,\"base_sales_margin_dollars_td\":null,\"adjusted_cost_dollars\":null,\"base_aur_uf\":null,\"sales_units_lift_td\":null,\"regular_sales_margin_dollars_if\":0,\"promo_description\":null,\"size_description\":null,\"lift_vs_spend_percentage_uf\":null,\"sales_units_lift_percentage_if\":0,\"sales_dollars_lift_uf\":null,\"base_sales_units_sf\":null,\"vehicle\":\"EDLP\",\"base_sales_margin_dollars_af\":null,\"cost_dollars\":null,\"sub_category_id\":[\"9112\"],\"average_unit_retail\":null,\"total_sales_units_if\":null,\"regular_price_dollars_max_uf\":null,\"cloned_from\":null,\"max_price\":null,\"promo_start_date\":\"2024-04-04\",\"sales_dollars_lift_percentage_af\":null,\"regular_sales_units_td\":null,\"max_cost\":null,\"promotional_sales_margin_dollars_td\":null,\"prevailing_price\":null,\"promo_type\":\"Amount Off\",\"base_aur_if\":null,\"assignee_name\":\"Promo Planner\",\"regular_sales_margin_dollars_uf\":0,\"batch_processed\":false,\"promo_auc_sf\":null,\"base_auc_af\":null,\"min_cost\":null,\"sales_dollars_lift_percentage_if\":null,\"total_sales_margin_dollars_uf\":null,\"sales_margin_dollars_lift_percentage_sf\":null,\"regular_sales_units_if\":0,\"total_sales_dollars_sf_rel_diff_to_td\":null,\"total_sales_units_td_rel_diff_to_af\":null,\"total_sales_units_uf\":null,\"value_to_customer_percentage\":null,\"base_sales_units_af\":null,\"total_sales_margin_dollars_if\":null,\"sales_dollars_lift_if\":null,\"base_sales_dollars_td\":null,\"commentator_user_id\":\"2\",\"promo_group_id\":null,\"total_sales_margin_percentage_if\":null,\"promo_aur_sf\":null,\"promotional_sales_margin_dollars_sf\":null,\"promotional_margin_percentage\":null,\"department_id\":[\"14\"],\"computing\":false,\"total_sales_dollars_td\":null,\"large_promo\":false,\"base_aur_sf\":null,\"regular_sales_margin_dollars_af\":null,\"versions_ids\":[],\"nullify_overridable\":null,\"total_sales_units_af_rel_diff_to_td\":null,\"total_sales_margin_percentage_uf\":null,\"regular_sales_margin_dollars_sf\":null,\"created_from_event_id\":null,\"lift_vs_spend_percentage_td\":null,\"lift_vs_spend_percentage_af\":null,\"drift_changed\":null,\"sales_units_lift_percentage_td\":null,\"product_count\":23,\"brand\":[\"FRIGIDAIRE\",\"WHIRLPOOL\",\"SAMSUNG\",\"LG\",\"BOSCH\"],\"base_auc_sf\":null,\"created_from_invitation_id\":null,\"sales_units_lift_sf\":null,\"promo_status\":\"Ready\",\"sales_margin_dollars_lift_af\":null,\"advertising_instructions\":\"\",\"promotional_sales_units_td\":null,\"redemption_count_td\":null,\"base_sales_margin_dollars_if\":null,\"sub_department_id\":[],\"approval_date\":null,\"submission_status\":null,\"promotional_sales_dollars_af\":null,\"total_sales_units_td_rel_diff_to_sf\":null,\"total_sales_units_af\":null,\"promotional_sales_margin_dollars_uf\":null,\"base_auc_uf\":null,\"department\":[\"APPLIANCES\"],\"sales_dollars_lift_af\":null,\"total_sales_units_td\":null,\"sales_units_lift_percentage_uf\":0,\"secondary_image_id\":null,\"promo_name\":\"alooooo\",\"promo_auc_uf_override\":null,\"regular_sales_units_uf\":0,\"fiscal_week\":[\"2024-03-31\"],\"sub_department\":[],\"sales_dollars_lift_sf\":null,\"regular_sales_dollars_sf\":null,\"promotional_sales_units_uf\":null,\"fiscal_quarter\":[\"202403\"],\"lift_vs_spend_percentage_if\":null,\"promotional_sales_units_sf\":null,\"sales_dollars_lift_percentage_uf\":null,\"regular_sales_dollars_td\":null,\"units_per_redemption_td\":null,\"base_cost_dollars_max_uf\":null,\"promo_aur_af\":null,\"base_sales_margin_dollars_sf\":null,\"has_comments\":false,\"total_sales_margin_percentage_af\":null,\"discount_percentage\":null,\"promo_aur_if\":null,\"internal_contribution\":null,\"promotional_sales_discount_dollars_if\":null,\"promo_id\":\"P00000011\",\"used_in\":null,\"forecast_gross_margin_dollars\":null,\"seeded_deal_number\":null,\"total_sales_margin_dollars_sf_rel_diff_td\":null,\"sales_units_lift_uf\":0,\"sales_margin_dollars_lift_sf\":null,\"total_sales_margin_dollars_td\":null,\"product_group_ids\":[\"86b224c3-1bd6-44fd-87e8-99c016018ed3\"],\"total_sales_dollars_sf\":null,\"sales_units_lift_if\":0,\"primary_objective\":null,\"promotional_margin_dollars\":null,\"sales_margin_dollars_lift_percentage_uf\":null,\"total_sales_dollars_if\":null,\"total_sales_dollars_uf\":null,\"overridden_metrics\":[],\"sales_units_lift_af\":null,\"content\":\"\",\"sales_dollars_lift_td\":null,\"total_sales_units_sf_rel_diff_to_td\":null,\"media\":null,\"sales_margin_dollars_lift_percentage_af\":null,\"promo_auc_uf\":null,\"promotional_sales_dollars_uf\":null,\"sales_margin_dollars_lift_percentage_if\":null,\"category\":[\"MAJOR KITCHEN APPLIANCE\"],\"location_count\":125,\"bold_ad_text\":\"\",\"promo_auc_af\":null,\"total_sales_margin_percentage_td\":null,\"average_unit_cost\":null,\"sales_dollars_lift_percentage_td\":null,\"category_id\":[\"432\"],\"created_at\":\"1712132339\",\"submitted_by\":null,\"promo_auc_if\":null,\"discount_dollars\":20,\"advertising_bug\":null,\"sales_dollars_lift_percentage_sf\":null,\"total_sales_margin_dollars_sf\":null,\"auc_changed\":null,\"regular_sales_units_af\":null,\"promotional_sales_dollars_td\":null,\"regular_price_dollars\":null,\"base_sales_dollars_sf\":null,\"regular_sales_dollars_uf\":0,\"promotional_sales_units_if\":null,\"is_reopened\":\"Yes\",\"sales_margin_dollars_lift_if\":null,\"vendor_funding\":null,\"forecast_sales_dollars\":null,\"finalized_event_ids\":[],\"regular_sales_units_sf\":null,\"total_sales_margin_dollars_af\":null,\"regular_price_dollars_min_uf\":null,\"promo_expression\":\"GET $20.00 off firas\",\"lift_vs_spend_percentage_sf\":null,\"promotional_sales_margin_dollars_af\":null,\"updated_at\":\"1712143155\",\"category_manager\":null,\"regular_sales_dollars_if\":0,\"rejected_by\":null,\"value_to_customer_dollars\":null,\"base_sales_dollars_if\":null,\"promotional_price_dollars\":null,\"promo_end_date\":\"2024-04-04\",\"approved_by\":null,\"redemption_rate_td\":null,\"sales_margin_dollars_lift_percentage_td\":null,\"total_sales_margin_dollars_af_rel_diff_to_td\":null,\"base_sales_units_uf\":null,\"internal_comments\":\"\",\"vendor_promo_expense_percentage\":null,\"aur_changed\":null,\"internal_promo_expense_percentage\":null,\"promo_aur_uf\":null,\"parity_id\":null,\"promo_group_name\":null,\"card_type\":\"No Card\",\"regular_sales_margin_dollars_td\":null,\"min_price\":null,\"total_sales_margin_percentage_sf\":null,\"promotional_sales_dollars_if\":null,\"forecast_sales_units\":null,\"sales_units_lift_percentage_af\":null,\"commentator_user_name\":\"Promo Planner\"}","kubernetes":{"pod_name":"promo-planning-service-76776b9dc4-rcwmx","namespace_name":"frigui-dev","pod_id":"9b19b1e5-cf06-4b7a-acd5-5ea5f4d110d3","labels":{"app":"promo-planning-service","pod-template-hash":"76776b9dc4"},"annotations":{"linkerd.io/inject":"enabled","rollme":"UlGwE"},"host":"aks-mainpool-16235376-vmss00000u","container_name":"promo-planning-service","docker_id":"8f617240848c3e36bbc0eded06d6528f73b1973571ca44c0f72e57b9516963ab","container_hash":"devcognira.azurecr.io/cognira/promoai/promo-planning-service@sha256:5fe7d5220c01caee441e756cd7314e0fcb5d47864f1eeae170c2d7734718c96d","container_image":"devcognira.azurecr.io/cognira/promoai/promo-planning-service:frigui-logs"}}""" // Output: {"name":"John","age":30}
        val jsonString2 = """{"@timestamp":1712143064.751285,"stream":"stdout","logtag":"F","message":"2024-04-03 11:17:44.751 INFO  com.cognira.shared.metric.models.MetricsEntity - Logs for FluentBit are : {\"id\":\"1userpromo\",\"p1\":\"1\",\"c1\":\"P00000011\",\"permission\":\"rdfoesv\",\"sales_units_lift_percentage_sf\":6}","kubernetes":{"pod_name":"promo-planning-service-76776b9dc4-rcwmx","namespace_name":"frigui-dev","pod_id":"9b19b1e5-cf06-4b7a-acd5-5ea5f4d110d3","labels":{"app":"promo-planning-service","pod-template-hash":"76776b9dc4"},"annotations":{"linkerd.io/inject":"enabled","rollme":"UlGwE"},"host":"aks-mainpool-16235376-vmss00000u","container_name":"promo-planning-service","docker_id":"8f617240848c3e36bbc0eded06d6528f73b1973571ca44c0f72e57b9516963ab","container_hash":"devcognira.azurecr.io/cognira/promoai/promo-planning-service@sha256:5fe7d5220c01caee441e756cd7314e0fcb5d47864f1eeae170c2d7734718c96d","container_image":"devcognira.azurecr.io/cognira/promoai/promo-planning-service:frigui-logs"}}"""
        val Pntt1 = createNtt(jsonString1) // Simulated function to create Ntt
        val Pntt2 = createNtt(jsonString2)

        // Verify the type of messages before sending
        assert(Pntt1.isRight)
        assert(Pntt2.isRight)

        val probe = testKit.createTestProbe[Any]()

        (Pntt1, Pntt2) match {
          case (Right(ntt1), Right(ntt2)) =>
            (getIds(ntt1), getIds(ntt2)) match {
              case (Right((id1, p1, c1)), Right((id2, p2, c2))) =>
                val nttHandler = testKit.spawn(entityHandler(id1, p1, c1), "entityHandler")
                nttHandler ! updateNtt(Pntt1, probe.ref)
                nttHandler ! updateNtt(Pntt2, probe.ref)
                val received = probe.receiveMessage()
                received shouldBe a[nttUpdated]
                val received2 = probe.receiveMessage()
                received2 shouldBe a[nttUpdated]
            }
        }
      }
    }
  }
}